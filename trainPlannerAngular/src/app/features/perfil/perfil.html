  <div class="container mt-3">
    <h2>Mi Perfil</h2>

    <!-- Alerta de verificación de email -->
    @if (needsEmailVerification()) {
      <div class="alert alert-warning">
        <h5>Verificación de Email Requerida</h5>
        <p>Para acceder a todas las funcionalidades de tu cuenta, necesitas verificar tu dirección de email.</p>
        
        @if (resendSuccess) {
          <div class="alert alert-success mt-2">
            Email de verificación reenviado. Revisa tu bandeja de entrada.
          </div>
        }
        
        <button 
          class="btn btn-primary mt-2" 
          (click)="resendVerificationEmail()"
          [disabled]="resendingEmail">
          {{ resendingEmail ? 'Enviando...' : 'Reenviar Email de Verificación' }}
        </button>
      </div>
    }

    @if (user) {
      <div class="row">
        <!-- Columna izquierda: Información personal -->
        <div class="col-md-8 mb-4">
          <div class="card mb-4">
            <div class="card-header bg-light">
              <h5 class="card-title mb-0">
                <i class="bi bi-person-circle me-2"></i>Información Personal
              </h5>
            </div>
            <div class="card-body">
              <!-- Sección de foto con preview -->
              <div class="text-center mb-4">
                @if (photoPreview) {
                  <!-- Preview de la nueva foto seleccionada -->
                  <img
                    class="rounded-circle mb-3 border border-primary border-3"
                    [src]="photoPreview"
                    width="120"
                    height="120"
                    style="object-fit: cover;"
                    id="profile-photo-preview">
                  <div class="text-primary small mb-2">
                    <i class="bi bi-eye me-1"></i> Vista previa - Cambio pendiente
                  </div>
                } @else {
                  <!-- Foto actual del usuario o default -->
                  <img
                    class="rounded-circle mb-3 profile-photo"
                    [src]="getUserPhotoUrl()"
                    width="120"
                    height="120"
                    style="object-fit: cover;"
                    id="current-profile-photo"
                    (load)="onPhotoLoaded()"
                    (error)="onPhotoError()">
                }
              </div>

              <div class="row">
                <div class="col-md-6 mb-3">
                  <p><strong>Nombre:</strong> {{ user.name }}</p>
                </div>
                <div class="col-md-6 mb-3">
                  <p><strong>Email:</strong> {{ user.email }}</p>
                </div>
                <div class="col-md-6 mb-3">
                  <p><strong>Rol:</strong> {{ getUserRole() }}</p>
                </div>
                <div class="col-md-6 mb-3">
                  <p><strong>Email verificado: </strong> 
                    @if (user.email_verified_at || user.email_verified) {
                      <span class="badge bg-success">Verificado</span>
                    } @else {
                      <span class="badge bg-warning">Pendiente</span>
                    }
                  </p>
                </div>
                @if (user.dni) {
                  <div class="col-md-6 mb-3">
                    <p><strong>DNI:</strong> {{ user.dni }}</p>
                  </div>
                }
              </div>

              <hr>

              <h5>Notas personales</h5>
              <textarea
                class="form-control mb-2"
                [(ngModel)]="user.notes"
                rows="4"
                placeholder="Añade notas sobre ti (alergias, enfermedades, observaciones...)"></textarea>
              <small class="text-muted">Esta información solo es visible para ti y los administradores.</small>
              <br>
              <button class="btn btn-secondary mt-2" (click)="updateNotes()">Guardar notas</button>

              <hr>

              <h5>Foto de perfil</h5>
              
              <!-- Botón para cancelar preview si hay foto seleccionada -->
              @if (photoPreview) {
                <div class="alert alert-info mb-3">
                  <div class="d-flex justify-content-between align-items-center">
                    <span><i class="bi bi-info-circle me-2"></i>Foto seleccionada para subir</span>
                    <button class="btn btn-sm btn-outline-secondary" (click)="cancelPhotoSelection()">
                      <i class="bi bi-x"></i> Cancelar
                    </button>
                  </div>
                </div>
              }
              
              <input 
                type="file" 
                class="form-control mb-3" 
                (change)="onFileSelected($event)" 
                accept="image/*"
                [disabled]="uploadingPhoto"
                #fileInput>
              
              <div class="d-flex gap-2">
                <button 
                  class="btn btn-primary" 
                  (click)="upload()" 
                  [disabled]="!selectedFile || uploadingPhoto">
                  @if (uploadingPhoto) {
                    <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                    Subiendo...
                  } @else {
                    <i class="bi bi-cloud-upload me-2"></i>Subir foto
                  }
                </button>
                
                @if (photoPreview) {
                  <button 
                    class="btn btn-outline-secondary" 
                    (click)="cancelPhotoSelection()"
                    [disabled]="uploadingPhoto">
                    <i class="bi bi-x-circle me-1"></i>Cancelar
                  </button>
                }
              </div>

              <!-- Progress bar durante la subida -->
              @if (uploadingPhoto) {
                <div class="progress mt-3" style="height: 8px;">
                  <div class="progress-bar progress-bar-striped progress-bar-animated" 
                      role="progressbar" 
                      style="width: 100%">
                  </div>
                </div>
                <div class="text-center mt-2">
                  <small class="text-muted">Subiendo foto al servidor...</small>
                </div>
              }
              
              <!-- Mensaje de éxito (oculto por defecto) -->
              @if (showSuccessMessage) {
                <div class="alert alert-success alert-dismissible fade show mt-3" role="alert">
                  <i class="bi bi-check-circle me-2"></i>
                  <strong>¡Éxito!</strong> Foto de perfil actualizada correctamente.
                  <button type="button" class="btn-close" (click)="showSuccessMessage = false"></button>
                </div>
              }
            </div>
          </div>
        </div>

        <!-- Columna derecha: Estado de suscripción (solo para trainees) -->
        @if (user.role === 'trainee') {
          <div class="col-md-4 mb-4">
            <app-subscription-status></app-subscription-status>
          </div>
        }
      </div>
    }

    <!-- Modal de éxito para notas -->
    <app-success-modal 
      message="Nota actualizada exitosamente." 
      #successModal>
    </app-success-modal>
  </div>